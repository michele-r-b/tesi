\chapter{Caso di Studio: Sistema Domotico Integrato con Apple HomeKit}

\section{Obiettivi e contesto}
Questo caso di studio documenta l’implementazione di un sistema domotico per una residenza unifamiliare su due piani, integrato nativamente con Apple HomeKit. 

I requisiti riguardano: (i) controllo accessi sicuro; (ii) gestione dell’illuminazione e delle tapparelle; (iii) videosorveglianza perimetrale con notifiche mirate; (iv) monitoraggio ambientale e automazioni meteo; (v) audio multi stanza; (vi) facilità d’uso tramite app Casa e comandi vocali; (vii) riduzione dei consumi energetici senza impattare il comfort.

\section{Analisi dell’abitazione}
\textbf{Piano terra} (100 m²): ingresso, soggiorno open-space (40 m²), cucina abitabile (25 m²), bagno ospiti, studio/ufficio (15 m²), garage doppio.\\
\textbf{Piano primo} (100 m²): camera matrimoniale con bagno, due camere singole, bagno principale, terrazzo (20 m²).\\
\textbf{Esterno}: giardino perimetrale, vialetto d’accesso, due accessi carrabili, area barbecue.

Vincoli progettuali: distribuzione su due piani (copertura Wi‑Fi e latenza), esposizioni est/ovest (controllo solare), necessità di integrazione non invasiva su impianto esistente e preferenza per controllo nativo da ecosistema Apple. Facilità di gestione e condivisione con i membri della famiglia.

\section{Architettura del sistema}
L’architettura è organizzata su tre livelli: (a) \textit{dispositivi e sensori}; (b) \textit{hub/controller e gateway}; (c) \textit{automazioni e interfacce}.

\subsection{Rete e infrastruttura}
\begin{itemize}
  \item \textbf{LAN IoT dedicata}: VLAN 192.168.20.0/24, SSID dedicato (WPA3), segmentazione del traffico verso la LAN principale.
  \item \textbf{Hub HomeKit}: HomePod in soggiorno come hub primario; HomePod mini in cucina, studio e camera matrimoniale come hub di failover e per audio locale.
  \item \textbf{Gateway BTicino}: modulo DIN collegato alla rete Wi-Fi per la configurazione dei dispositivi su home control e condivisione con HomeKit.
\end{itemize}

\subsection{Protocolli e integrazione}
\begin{itemize}
  \item \textbf{Bus SCS (BTicino)}: utilizzato per la comunicazione tra moduli Living Now cablati (interruttori, dimmer e comandi tapparelle) e il gateway, quando l’impianto lo prevede. Garantisce bassa latenza e funzionalità anche in assenza di rete IP.
  \item \textbf{Wi-Fi}: impiegato dai dispositivi Living Now connessi \textit{pre-Matter} (installati in questa abitazione), dal Nuki Smart Lock 3.0 Pro, dalle telecamere Netatmo e dalla stazione meteo Netatmo. È il principale canale di comunicazione verso HomeKit in questa configurazione.
  \item \textbf{Thread}: utilizzato esclusivamente da dispositivi compatibili Matter o nativamente Thread, come le Nanoleaf Lines. La rete Thread è gestita dai Border Router integrati in HomePod mini e HomePod (2ª gen), garantendo bassa latenza e consumo energetico ridotto.
  \item \textbf{Interruttori BTicino wireless}: modelli da parete privi di cablaggio, alimentati a batteria con comunicazione radio diretta con il gateway via Thread.
  \item \textbf{HomeKit su IP}: protocollo applicativo utilizzato per automazioni e controlli, con cifratura end-to-end e pairing tramite codice QR.
  \item \textbf{HomeKit Secure Video (HKSV)}: per le telecamere Netatmo, con analisi video on-device e registrazione cifrata su iCloud.
\end{itemize}

\section{Dotazione installata (per categoria)}
\subsection*{Accesso e sicurezza}
\begin{itemize}
  \item \textbf{Serratura smart}: Nuki Smart Lock 3.0 Pro (integrazione HomeKit via Wi‑Fi). Funzioni: blocco/sblocco, stato porta, automazioni in base a presenza e orario. La gestione delle credenziali ospiti avviene nell’app Nuki; HomeKit fornisce controllo e notifiche.
  \item \textbf{Videosorveglianza esterna}: 4 telecamere Netatmo Outdoor con sirena. In HomeKit Secure Video: rilevamento persone/animali/veicoli, zone di attività, timeline cifrata. Posizionamento: ingresso, garage, giardino posteriore, lato secondario.
\end{itemize}

\subsection*{Illuminazione e schermature}
\begin{itemize}
  \item \textbf{Punti luce e dimmer}: serie BTicino Living Now per 32 punti luce (on/off e dimmerazione). Comandi scenari locali per richiamo rapido.
  \item \textbf{Tapparelle}: 18 motorizzazioni con controllo salita/discesa/stop e posizionamento percentuale; scenari alba/tramonto.
\end{itemize}

\subsection*{Monitoraggio ambientale e meteo}
\begin{itemize}
  \item \textbf{Stazione meteo Netatmo}: modulo interno (temperatura, umidità, CO\textsubscript{2}, pressione, rumore) e modulo esterno (temperatura/umidità). Dati usati per automazioni (protezione solare, avvisi vento/calore).
  \item \textbf{Sensori integrati HomePod}: temperatura/umidità ambientale disponibili in HomeKit per regole semplici di comfort.
\end{itemize}

\subsection*{Audio, interazione e notifiche}
\begin{itemize}
  \item \textbf{HomePod / HomePod mini}: audio multi-room, comandi vocali, Intercom, hub HomeKit con failover. Integrazione con scene (es. modalità cinema, sveglia graduale).
\end{itemize}

\subsection*{Illuminazione decorativa}
\begin{itemize}
  \item \textbf{Nanoleaf Lines}: installazione a parete in soggiorno (dietro TV). Integrazione con HomeKit per scene; effetti dinamici per notifiche e modalità cinema. Connessione di rete via Wi‑Fi; supporto a protocolli low-latency ove disponibile.
\end{itemize}

\section{Implementazione}
\subsection{Fase 1 — Infrastruttura elettrica e di rete}
\begin{enumerate}
  \item Installazione del gateway BTicino su barra DIN e predisposizione protezioni dedicate.
  \item Alimentazioni per telecamere esterne.
  \item Configurazione VLAN/SSID IoT, indirizzamento statico per dispositivi fissi (telecamere, gateway), WPA3.
\end{enumerate}

\subsection{Fase 2 — Installazione dispositivi}
\begin{itemize}
  \item Sostituzione interruttori tradizionali con moduli Living Now; configurazione dimmer nelle zone principali; comandi tapparelle.
  \item Montaggio Nuki su porta blindata con calibrazione.
  \item Installazione telecamere Netatmo e definizione delle zone di attività.
  \item Posizionamento HomePod/HomePod mini e installazione Nanoleaf Lines.
\end{itemize}

\subsection{Fase 3 — Configurazione HomeKit}
\begin{enumerate}
  \item Aggiunta del gateway BTicino tramite codice HomeKit; rilevamento automatico dei dispositivi collegati.
  \item Pairing di telecamere e stazione meteo Netatmo; abilitazione HKSV.
  \item Configurazione Nuki via QR e verifica controlli da app Casa.
  \item Impostazione HomePod come hub primario e verifica dei servizi remoti.
  \item Organizzazione in stanze/piani e definizione di zone (interno/esterno).
\end{enumerate}

\section{Automazioni rappresentative}
Le automazioni sono progettate con logica "\textit{evento-condizione-azione}", utilizzando trigger affidabili e preferendo esecuzione locale quando possibile.

\subsection*{Protezione notturna}
\begin{verbatim}
Trigger: tramonto + 30 min; presenza = true
Azioni: chiusura tapparelle piano terra; accensione luci esterne;
        telecamere in alta sensibilità; blocco automatico serratura.
Notifiche: sintesi eventi su iPhone dei genitori.
\end{verbatim}

\subsection*{Arrivo familiare (riconoscimento)}
\begin{verbatim}
Trigger: Netatmo ingresso -> persona riconosciuta; fascia oraria: 18:00-23:00
Azioni: luce ingresso 100% a 3000K; avviso su HomePod (Intercom);
        sblocco manuale facilitato (notifica azionabile da Apple Watch/iPhone).
\end{verbatim}

\subsection*{Ottimizzazione solare estiva}
\begin{verbatim}
Trigger: temperatura esterna > 26°C; meteo soleggiato
Condizioni: stagione = estate; qualcuno in casa = true
Azioni progressive: lato est 70% (10:00); lato sud 80% (12:00);
                   lato ovest 70% (15:00); apertura al tramonto.
\end{verbatim}

\subsection*{Sveglia graduale}
\begin{verbatim}
Trigger: 07:00 (feriali) / 08:30 (weekend)
Azioni: tapparelle camera 30% con apertura lenta; luce 20% a 2700K (5 min);
        HomePod: riproduzione playlist con volume in fade-in.
\end{verbatim}

\subsection*{Modalità cinema}
\begin{verbatim}
Trigger: comando vocale "Ehi Siri, modalità cinema" o pulsante scena
Azioni: chiusura tapparelle soggiorno; spegnimento luci;
        Nanoleaf Lines in Screen/Mirror a 30%;
        HomePod in modalità Home Theater; notifiche familiari silenziate (2 ore).
\end{verbatim}

\section{Gestione utenti, permessi e privacy}
\begin{itemize}
  \item \textbf{Ruoli HomeKit}: genitori come amministratori (gestione dispositivi, automazioni, registrazioni video); figli come membri con accesso a luci/tapparelle e audio nelle loro stanze; esclusi controlli su serratura e telecamere.
  \item \textbf{HKSV e dati}: analisi movimento on-device, video cifrati end-to-end con storage iCloud; definizione di zone sensibili per ridurre notifiche superflue.
  \item \textbf{Accessi ospiti}: gestione credenziali temporanee tramite app Nuki; revoca immediata; log accessi consultabile.
\end{itemize}

\section{Conclusioni: vantaggi dell'integrazione multimarca}
L'adozione di un'architettura HomeKit in un contesto multimarca, come quello descritto in questo caso di studio, ha permesso di ottenere un impianto coerente, sicuro e facile da gestire.

\paragraph{Principali vantaggi osservati}
\begin{itemize}
  \item \textbf{Gestione centralizzata}: controllo di dispositivi BTicino, Netatmo, Nuki e Nanoleaf da un'unica interfaccia (app Casa), senza necessità di app separate per l'uso quotidiano su ogni device.
  \item \textbf{Condivisione semplificata}: accesso esteso a tutti i membri della famiglia tramite Condivisione in famiglia Apple, senza configurazioni aggiuntive.
  \item \textbf{Privacy e sicurezza}: automazioni locali e cifratura end-to-end nativa di HomeKit; per i video, HomeKit Secure Video con analisi on-device e archiviazione cifrata.
  \item \textbf{Riduzione della complessità}: eliminazione di gateway e bridge multipli, con aggiornamenti e notifiche centralizzati.
  \item \textbf{Affidabilità operativa}: continuità di funzionamento locale per luci, tapparelle e scenari principali anche in assenza di connessione Internet.
  \item \textbf{Esperienza uniforme}: interfaccia e comandi vocali coerenti su iPhone, iPad, Mac e Apple Watch.
  \item \textbf{Scalabilità futura}: predisposizione della rete per dispositivi Matter/Thread, grazie alla presenza di border router integrati (HomePod).
  \item \textbf{Efficienza energetica}: automazioni di illuminazione e schermature solari che contribuiscono alla riduzione dei consumi e al miglioramento del comfort abitativo.
  \item \textbf{Maggiore sicurezza di rete}: segmentazione VLAN dedicata all'IoT e isolamento del traffico rispetto alla rete principale.
\end{itemize}

\noindent In sintesi, la soluzione implementata dimostra come un ecosistema aperto e interoperabile, basato su standard consolidati come HomeKit, possa integrare tecnologie di produttori diversi garantendo facilità d'uso, sicurezza e possibilità di evoluzione nel tempo.